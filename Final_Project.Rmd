---
title: "Final_Project"
author: "Tessa Danehy, Josh Eiland, Chirag Kulkarni"
date: "11/17/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(tidyverse)
#install.packages("naniar")
#install.packages("finalfit")
library(finalfit)
library(naniar)
library(caret)
require(randomForest)
data = read.csv("train.csv")
```

Since we are getting the data from the NFL Big Data Bowl competition, the database is pretty robust. After creating a missing values map (below), we can see that most of the information is complete, with the exception of weather data. 

Temperature (and to a lesser extent humidity) information seems to be missing at various points throughout the data. This is curious as there is weather data out there and we could likely find a way to populate those fields knowing the day and location of the game. We may first see how significant temperature is in predicting rush yardage to determine if completing the temp data is worth it. 

Following this, we looked at a summary of the data to determine 1) whether the data was in the right format and 2) if there were any unreasonable values. Again, the data from the NFL is pretty great so all the data came in the correct format (categoricals for team name, player name, location, etc). There are a few features that we may engineer though: age of player (from birth day) and minutes into game (from game clock). 

For some next steps, we want to take a look at each of the column variables critically and determine which we want to test in a potential model. Ultimately, we will be experimenting with many different variables but we may rule some out from the offset. After that, we would like to connect to a database (NFL API) to get player stats and/or rankings. There is data out there such as Average Yards Per Play for each player and that could certainly improve our model. 

```{r Assessing the data}
missing_plot(data)
# many of the values had empty strings instead of NAs, so we assigned them as NAs and ran missingness plot again 
data[data==''] = NA
missing_plot(data)

summary(data)
```


```{r Cleaning the Data}

# removing all players that are not the rusher, and then removing columns with variables we deem unimportant
df <- filter(data, data$NflId==data$NflIdRusher) %>% select(-c(JerseyNumber,Stadium,Location,WindSpeed, WindDirection))
names(df)

# used the summary() or levels() function on each variable to get a sense of strange values or variables that may be useful. Code omitted for simplicity 
# conclusions: offence personnel and defense personnel are very helpful, we should break them down
head(levels(df$OffensePersonnel))
# more ideas for feature engineering- create age from date of birth variable

# things we need to look into:
# possession team- there are 33 values
# field position 34 values
# offence formation has 10 values
# position has like 30 abbreviations and idk what they are
# temp, humidity has tons of NAs

# cleaning Stadium type ( makes new column called StadiumTypeNew)
levels(df$StadiumType)
outdoor = c("Cloudy", "Domed, open", "Domed, Open", "Open", "Oudoor", "Ourdoor", "Outddors","Heinz Field", "Indoor, Open Roof", "Outdoor", "Outdoor Retr Roof-Open", "Outdoors", "Outdor","Outside","Retr. Roof - Open", "Retr. Roof-Open")
indoor = c("Bowl", "Closed Dome", "Dome", "Dome, closed", "Domed", "Domed, closed", "Indoor","Indoor, Roof Closed", "Indoors", "Retr. Roof - Closed", "Retr. Roof Closed", "Retr. Roof-Closed","Retr. Roof-Closed", "Retractable Roof")
df$StadiumTypeNew = NA
df[df$StadiumType %in% outdoor == TRUE, which(colnames(df)=="StadiumTypeNew")] <- 'Outdoor'
df[df$StadiumType %in% indoor == TRUE, which(colnames(df)=="StadiumTypeNew")] <- 'Indoor'
levels(as.factor(df$StadiumTypeNew))
df$StadiumType = NULL

# cleaning Turf (makes new column called TurfNew)
levels(df$Turf)
artificialTurf = c("A-Turf Titan","Artifical","Artificial", "Field turf", "Field Turf", "FieldTurf", "FieldTurf 360", "FieldTurf360","Twenty-Four/Seven Turf", "UBU Speed Series-S5-M", "UBU Sports Speed S5-M")
naturalGrass = c("DD GrassMaster", "grass", "Grass", "Natural", "natural grass", "Natural grass", "Natural Grass", "Naturall Grass", "SISGrass")
df$TurfNew <- NA
df[df$Turf %in% artificialTurf == TRUE, which(colnames(df)=="TurfNew")] <- 'Turf'
df[df$Turf %in% naturalGrass == TRUE, which(colnames(df)=="TurfNew")] <- 'Grass'
levels(as.factor(df$TurfNew))
df$Turf <-NULL

# cleaning Player Height- changing it to inches (new feature called HeightNew)
for (cur in 1:nrow(df))
{
  height <- str_split_fixed(df$PlayerHeight[cur], '-', 2)
  height1 <- as.numeric(height[1])
  height2 <- as.numeric(height[2])
  df$HeightNew[cur] <- height1*12+height2
} 
df$PlayerHeight <- NULL

# cleaning GameWeather- sort into adverse (rain and snow) and non-adverse conditions (called WeatherNew)
levels(df$GameWeather)
adverse<- c("30% Chance of Rain", "Cloudy with periods of rain, thunder possible. Winds shifting to WNW, 10-20 mph.", "Cloudy, 50% change of rain", "Cloudy, chance of rain",  "Cloudy, light snow accumulating 1-3\"", "Cloudy, Rain" , "Heavy lake effect snow", "Light Rain", "Rain", "Rain Chance 40%","Rain likely, temps in low 40s.", "Rain shower", "Rainy","Scattered Showers", "Showers", "Snow")
df$WeatherNew = NA
df[df$GameWeather %in% adverse == TRUE, which(colnames(df)=="WeatherNew")] <- 'Adverse'
df[df$GameWeather %in% adverse == FALSE, which(colnames(df)=="WeatherNew")] <- 'Not Adverse'
df$GameWeather <- NULL

```


```{r reCat}

# Recategorizing the yardage to one of four categories
df$Cat <- "-"
# Negative plays
df[df$Yards < 0, which(colnames(df)=="Cat")] <- "Negative"
# Positive plays of less than 4 yards
df[df$Yards >= 0 & df$Yards < 4, which(colnames(df)=="Cat")] <- "Small"
# Plays of at least 4 but less than 10 yards
# This is the rate necessary to never face a 4th down
df[df$Yards >= 4 & df$Yards < 10, which(colnames(df)=="Cat")] <- "Medium"
# Plays gaining 10 or more yards - enough for a first down
   # (assuming no prior negative yardage since the last first down)
df[df$Yards >= 10, which(colnames(df)=="Cat")] <- "Large"
table(df$Cat)

short <- df[1:1000,]
setwd("C:/Users/jhe5a/OneDrive/Desktop/dsfinal")
write.csv(short,"short.csv")
```

```{r VarImp}
# Here we create a data partition in order to make training and test sets from the full data set
slim <- df[!is.na(df$FieldPosition),]
cut <- createDataPartition(df$Yards, p=0.8, list = FALSE)
train <- slim[cut,]
test <- slim[-cut,]
# We start with a basic random forest using only information about the player's location and motion

rf0 <- randomForest(Yards ~ Team + X + Y + S + A + Dis + Orientation + Dir, data=train,mtry=6,importance=TRUE) 
slim <- df[]

rf1 <- randomForest(Yards ~ Team + X + Y + S + A + Dis + Orientation + Dir + NflId + YardLine + Quarter + GameClock + Down + Distance + FieldPosition, data=train,mtry=6,importance=TRUE)
varImp(rf0)
varImpPlot(rf0,type=2)

pred1 <-predict(rf0,newdata=test) 
guess <- abs(mean(test$Yards) - test$Yards)
diff <- abs(pred1 - test$Yards)
mean(diff)

pred <- train(Yards~.,data=train,method='rf',metric=metric,
                    tuneGrid=tunegrid,trControl=control)

rf1 <- randomForest(train[,-c(31,40:46)],train$Yards,
                     sampsize=round(0.6*length(train[,31])),
                     ntree=500,mtry=sqrt(16),importance=TRUE)
## rf0 <- randomForest(Yards ~ Team + X + Y + S + A + Dis + Orientation + Dir, data=short,mtry=6,importance=TRUE) 
## rf0short <- randomForest(Cat ~ Team + X + Y + S + A + Dis + Orientation + Dir, data=short,mtry=6,importance=TRUE) 
```


```{r Feature Engineering}
head(df)


##First we calculate average rushing yards per play for all plays prior to the current play. 
df$Time <- strptime(df$TimeHandoff, format='%Y-%m-%dT%H:%M:%S') #Convert all time strings to a type that can be compared (POSIXlt)

for (current in 1:nrow(df)) #Run through every play
  {
    current_time <- df[current, 'Time'] 
    current_ID <- df[current, 'NflIdRusher']
    before_play <- subset(df, Time>current_time) #Create a subset of all plays that occurred before the selected play
    average <- mean(before_play$Yards[before_play$NflIdRusher==current_ID]) #Calculate the average of all the prior plays where the same rusher was playing 
    df$average[current]<-average #Store the average
}

averages <- df$average
df$average<-averages

# Next we need to calculate the age of the rusher at time of handoff
df$birth<-strptime(df$PlayerBirthDate, format='%m/%d/%Y')
for (current in 1:nrow(df)) #Run through every play
{
  current_time <- (df[current, 'Time'])
  birth_day <- (df[current, 'birth'])
  df$age[current] <- floor((difftime(current_time, birth_day, units='weeks')/52))
}

#Following this, we wanted to create a feature for the point difference. 

toString(df$PossessionTeam[4])==toString(df$HomeTeamAbbr[4])

for (current in 1:nrow(df))
{
  df$point_diff[current] <- ifelse(toString(df$PossessionTeam[current])==toString(df$HomeTeamAbbr[current]), df$HomeScoreBeforePlay[current]-df$VisitorScoreBeforePlay[current], df$VisitorScoreBeforePlay[current]-df$HomeScoreBeforePlay[current]) 
}

```




