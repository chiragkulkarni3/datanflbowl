---
title: "Final_Project"
author: "Tessa Danehy, Josh Eiland, Chirag Kulkarni"
date: "11/17/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(tidyverse)
#install.packages("naniar")
#install.packages("finalfit")
library(finalfit)
library(naniar)
data = read.csv("train.csv")
```

Since we are getting the data from the NFL Big Data Bowl competition, the database is pretty robust. After creating a missing values map (below), we can see that most of the information is complete, with the exception of weather data. 

Temperature (and to a lesser extent humidity) information seems to be missing at various points throughout the data. This is curious as there is weather data out there and we could likely find a way to populate those fields knowing the day and location of the game. We may first see how significant temperature is in predicting rush yardage to determine if completing the temp data is worth it. 

Following this, we looked at a summary of the data to determine 1) whether the data was in the right format and 2) if there were any unreasonable values. Again, the data from the NFL is pretty great so all the data came in the correct format (categoricals for team name, player name, location, etc). There are a few features that we may engineer though: age of player (from birth day) and minutes into game (from game clock). 

For some next steps, we want to take a look at each of the column variables critically and determine which we want to test in a potential model. Ultimately, we will be experimenting with many different variables but we may rule some out from the offset. After that, we would like to connect to a database (NFL API) to get player stats and/or rankings. There is data out there such as Average Yards Per Play for each player and that could certainly improve our model. 

```{r Assessing the data}
missing_plot(data)
# many of the values had empty strings instead of NAs, so we assigned them as NAs and ran missingness plot again 
data[data=='']=NA
missing_plot(data)

summary(data)
```


```{r Cleaning the Data}
# removing all players that are not the rusher, and then removing columns with variables we deem unimportant
df <- filter(data, data$NflId==data$NflIdRusher) %>% select(-c(JerseyNumber,Stadium,Location))
names(df)

# used the summary() or levels() function on each variable to get a sense of strange values or variables that may be useful. Code omitted for simplicity 
# conclusions: offence personnel and defense personnel are very helpful, we should turn them into multiple categories

summary(df$WindSpeed)
levels(df$WindDirection)
sum(is.na(df$WindSpeed))
summary(df$WindSpeed)

# look into:
# possession team- there are 33 values
# field position 34 values plus an empty ""
# offence formation has 10 values with an empty ""
# do we want player height to be a category or numerical? Rn is a category but I think numerical
# position has like 30 abbreviations and idk what they are
# clean stadium type, turf, GameWeather
# temp, humidity has tons of NAs
# remove wind speed? doesnt make sense 

# useful variables:
# offence personnel and defense personnel are very helpful
# should determine age from player birth date 

```



```{r Feature Engineering}
head(df)


##First we calculate average rushing yards per play for all plays prior to the current play. 
df$Time <- strptime(df$TimeHandoff, format='%Y-%m-%dT%H:%M:%S') #Convert all time strings to a type that can be compared (POSIXlt)

for (current in 1:nrow(df)) #Run through every play
  {
    current_time <- df[current, 'Time'] 
    current_ID <- df[current, 'NflIdRusher']
    before_play <- subset(df, Time>current_time) #Create a subset of all plays that occurred before the selected play
    average <- mean(before_play$Yards[before_play$NflIdRusher==current_ID]) #Calculate the average of all the prior plays where the same rusher was playing 
    df$average[current]<-average #Store the average
}

averages <- df$average
df$average<-averages

# Next we need to calculate the age of the rusher at time of handoff
df$birth<-strptime(df$PlayerBirthDate, format='%m/%d/%Y')
for (current in 1:nrow(df)) #Run through every play
{
  current_time <- (df[current, 'Time'])
  birth_day <- (df[current, 'birth'])
  df$age[current] <- floor((difftime(current_time, birth_day, units='weeks')/52))
}

#Following this, we wanted to create a feature for the point difference. 

toString(df$PossessionTeam[4])==toString(df$HomeTeamAbbr[4])

for (current in 1:nrow(df))
{
  df$point_diff[current] <- ifelse(toString(df$PossessionTeam[current])==toString(df$HomeTeamAbbr[current]), df$HomeScoreBeforePlay[current]-df$VisitorScoreBeforePlay[current], df$VisitorScoreBeforePlay[current]-df$HomeScoreBeforePlay[current]) 
}

```




